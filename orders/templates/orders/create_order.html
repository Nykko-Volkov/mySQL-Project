<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Order - Restaurant Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .customer-fields { display: none; }
        .customer-fields.show { display: block; }
        .form-section { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
        .section-title { color: #495057; font-weight: bold; margin-bottom: 15px; }
        .order-item { position: relative; }
        .order-item .remove-item { position: absolute; top: 8px; right: 8px; }
        .formset-empty { display: none; }
        .compact-label { font-weight: 600; font-size: .9rem; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Create New Order</h1>
        
        <!-- Show any messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="POST" action="">
            {% csrf_token %}
            
            <!-- Customer Information Section -->
            <div class="form-section">
                <div class="section-title">Customer Information</div>
                
                <!-- Customer Type Selection -->
                <div class="mb-3">
                    {{ order_form.customer_type.label_tag }}
                    {{ order_form.customer_type }}
                </div>
                
                <!-- Registered Customer Fields -->
                <div id="registered-customer" class="customer-fields">
                    <div class="mb-3">
                        {{ order_form.customer.label_tag }}
                        {{ order_form.customer }}
                        <small class="form-text text-muted">Select a registered customer from the list</small>
                    </div>
                </div>
                
                <!-- Walk-in Customer Fields -->
                <div id="walkin-customer" class="customer-fields show">
                    <div class="mb-3">
                        {{ order_form.customer_name.label_tag }}
                        {{ order_form.customer_name }}
                        <small class="form-text text-muted">Enter customer's name</small>
                    </div>
                    <div class="mb-3">
                        {{ order_form.customer_phone.label_tag }}
                        {{ order_form.customer_phone }}
                        <small class="form-text text-muted">Enter customer's phone number</small>
                    </div>
                </div>
            </div>
            
            <!-- Order Details Section -->
            <div class="form-section">
                <div class="section-title">Order Details</div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ order_form.order_type.label_tag }}
                            {{ order_form.order_type }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ order_form.table.label_tag }}
                            {{ order_form.table }}
                            <small class="form-text text-muted">Only for dine-in orders</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ order_form.status.label_tag }}
                    {{ order_form.status }}
                </div>
            </div>
            
            <!-- Order Items Section -->
            <div class="form-section">
                <div class="section-title">Order Items</div>
                
                {{ formset.management_form }}
                
                <div id="formset-container">
                    {% for form in formset %}
                        <div class="order-item mb-3 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
                            <button type="button" class="btn btn-sm btn-danger remove-item" title="Remove item">&times;</button>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <label class="compact-label">{{ form.product.label }}</label>
                                    {{ form.product }}
                                </div>
                                <div class="col-md-4">
                                    <label class="compact-label">{{ form.quantity.label }}</label>
                                    {{ form.quantity }}
                                </div>
                            </div>
                            {{ form.DELETE }}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Controls: select product then add via JS. Keep existing anchor (do not change links) -->
                <div class="mt-3 d-flex gap-2 align-items-center">
                    <select id="product-select" class="form-select w-50">
                        <option value="" selected>Select a product to add</option>
                        {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }} - ${{ product.price }}</option>
                        {% endfor %}
        
                    </select>

                    <!-- Keep original link unchanged as requested -->
                    <a href="{% url 'orders:add_item_to_order' %}" class="btn btn-sm btn-outline-secondary">Add Item</a>

                    <!-- JS-driven add button to create items in the formset without changing links -->
                    <button id="add-selected-btn" type="button" class="btn btn-sm btn-primary">Add Selected</button>

                    <div class="ms-auto text-muted">Items: <span id="item-count">{{ formset.total_form_count }}</span></div>
                </div>

            </div>
            
            <!-- Submit Button -->
            <div class="d-flex justify-content-between">
                <a href="{% url 'orders:order_list' %}" class="btn btn-outline-secondary">Cancel</a>
                <!-- add order item in oreddr form -->
                <button type="submit" class="btn btn-primary">Create Order</button>
            </div>
            
            <!-- Hidden empty form template (rendered server-side) -->
            <div id="empty-form-template" class="formset-empty">
                {{ formset.empty_form.as_p|escapejs }}
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show/hide customer fields based on customer type selection
        function toggleCustomerFields() {
            const radio = document.querySelector('input[name="customer_type"]:checked');
            const customerType = radio ? radio.value : null;
            const registeredFields = document.getElementById('registered-customer');
            const walkinFields = document.getElementById('walkin-customer');
            
            if (customerType === 'registered') {
                registeredFields.classList.add('show');
                walkinFields.classList.remove('show');
            } else {
                registeredFields.classList.remove('show');
                walkinFields.classList.add('show');
            }
        }
        
        // Add event listeners to radio buttons
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="customer_type"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', toggleCustomerFields);
            });
            
            // Set initial state
            toggleCustomerFields();

            // formset helpers
            const addBtn = document.getElementById('add-selected-btn');
            const productSelect = document.getElementById('product-select');
            const container = document.getElementById('formset-container');
            const emptyTemplateNode = document.getElementById('empty-form-template');
            // The empty form HTML was escaped for JS; get the actual HTML string from innerText
            const emptyFormEscaped = emptyTemplateNode ? emptyTemplateNode.textContent : '';
            // Unescape the JS-escaped HTML (it was produced by escapejs)
            function unescapeHtml(jsEscaped) {
                // Reverse of Django escapejs: create a temporary element and set textContent
                const t = document.createElement('textarea');
                t.textContent = jsEscaped;
                return t.value;
            }
            const emptyFormHtml = unescapeHtml(emptyFormEscaped);

            function getTotalFormsInput() {
                return document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]') ||
                       document.querySelector('input[name="form-TOTAL_FORMS"]');
            }
            const totalFormsInput = getTotalFormsInput();
            function getTotalForms() {
                return parseInt(totalFormsInput.value, 10);
            }
            function setTotalForms(n) {
                totalFormsInput.value = String(n);
            }

            function updateItemCount() {
                const countEl = document.getElementById('item-count');
                if (countEl) countEl.textContent = String(container.querySelectorAll('.order-item').length);
            }

            // Add new form to DOM using empty_form template
            function addForm(productId, productText, quantity) {
                const index = getTotalForms();
                if (!emptyFormHtml) return;
                // Replace the Django __prefix__ placeholder with the current index
                const formHtml = emptyFormHtml.replace(/__prefix__/g, index);
                // Create wrapper and insert
                const wrapper = document.createElement('div');
                wrapper.className = 'order-item mb-3 p-3 border rounded';
                wrapper.setAttribute('data-form-index', index);
                // Add remove button at top-right
                wrapper.innerHTML = '<button type="button" class="btn btn-sm btn-danger remove-item" title="Remove item">&times;</button>' + formHtml;
                container.appendChild(wrapper);

                // Set product and quantity if provided
                const select = wrapper.querySelector('select');
                const qtyInput = wrapper.querySelector('input[type="number"], input[type="text"]');

                if (select && productId) {
                    select.value = String(productId);
                }
                if (qtyInput && quantity !== undefined) {
                    qtyInput.value = String(quantity);
                }

                // Hook up remove button
                const removeBtn = wrapper.querySelector('.remove-item');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        // If a DELETE checkbox exists, mark it and hide; otherwise remove element and adjust TOTAL_FORMS
                        const deleteCheckbox = wrapper.querySelector('input[type="checkbox"][name$="-DELETE"]');
                        if (deleteCheckbox) {
                            deleteCheckbox.checked = true;
                            wrapper.style.display = 'none';
                        } else {
                            wrapper.remove();
                            // Decrement TOTAL_FORMS and re-index remaining forms to keep form names contiguous
                            reindexForms();
                        }
                        updateItemCount();
                    });
                }

                // Increase total forms
                setTotalForms(index + 1);
                updateItemCount();
            }

            // Re-index forms after removal (only used when physically removing forms)
            function reindexForms() {
                const items = container.querySelectorAll('.order-item');
                let idx = 0;
                items.forEach(item => {
                    // update data attribute
                    item.setAttribute('data-form-index', idx);
                    // update all name/id attributes that contain -<number>-
                    item.querySelectorAll('[name],[id]').forEach(el => {
                        if (el.name) {
                            el.name = el.name.replace(/-(\d+)-/g, `-${idx}-`);
                        }
                        if (el.id) {
                            el.id = el.id.replace(/-(\d+)-/g, `-${idx}-`);
                        }
                        // labels referring to ids
                        if (el.getAttribute('for')) {
                            el.setAttribute('for', el.getAttribute('for').replace(/-(\d+)-/g, `-${idx}-`));
                        }
                    });
                    idx++;
                });
                setTotalForms(idx);
            }

            // Attach remove handlers for pre-rendered items
            container.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function(ev) {
                    const wrapper = btn.closest('.order-item');
                    // If DELETE checkbox exists, mark it and hide wrapper
                    const deleteCheckbox = wrapper.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        wrapper.style.display = 'none';
                    } else {
                        wrapper.remove();
                        reindexForms();
                    }
                    updateItemCount();
                });
            });

            // Add selected product button handler
            addBtn.addEventListener('click', function() {
                const prodVal = productSelect.value;
                if (!prodVal) {
                    alert('Please select a product first.');
                    return;
                }
                const qty = 1;
                addForm(prodVal, productSelect.options[productSelect.selectedIndex].text, qty);
            });

            updateItemCount();
        });
    </script>
</body>
</html>